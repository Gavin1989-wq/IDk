<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coi vận mệnh</title>
<style>
  :root{
    --bg: #ffffff;
    --card: #ffffff;
    --text: #0b1220;
    --muted: #6b7280;
    --accent: #ff6b8a;
    --accent-2: #ff9ab0;
    --border: #e6e6e6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,Segoe UI,Roboto,Arial;
    background:var(--bg);
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
  }
  .wrap{
    width:100%;
    max-width:980px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,1), rgba(250,250,250,1));
    box-shadow: 0 8px 30px rgba(15,23,42,0.08);
    padding:18px;
    border:1px solid var(--border);
  }
  h1{margin:0 0 8px;font-size:24px}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} }
  label{display:block;margin-top:12px;margin-bottom:6px;font-weight:600}
  input[type="text"], input[type="number"]{
    width:100%; padding:10px; border-radius:10px;
    border:1px solid var(--border); background:#fff; color:var(--text);
    font-size:14px;
  }
  .btn{
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    border:none;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;
  }
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text);font-weight:600}
  .card{background:transparent;padding:12px;border-radius:10px}
  .muted{color:var(--muted);font-size:13px}
  .result{
    margin-top:12px;padding:12px;border-radius:10px;background:#fff;border:1px solid var(--border);
    box-shadow: 0 6px 18px rgba(15,23,42,0.03); white-space:pre-wrap;
  }
  .hidden{display:none !important}
  #confettiCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999}
  .playHint{margin-top:8px;font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<canvas id="confettiCanvas"></canvas>

<div class="wrap">
  <h1>Coi vận mệnh</h1>
  <!-- Ghi chú đã ẩn theo yêu cầu -->
  <div class="grid">
    <div class="card">
      <label>Họ và Tên</label>
      <input id="nameInput" type="text" placeholder="Nhập họ tên của bạn…">

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="findBtn" class="btn">Tìm & Chọn</button>
        <button id="resetBtn" class="btn ghost">Nhập lại</button>
      </div>

      <!-- nếu có nhiều trùng tên -->
      <div id="dupeBox" class="hidden" style="margin-top:12px">
        <div class="muted">Tên này có nhiều ngày sinh. Chọn đúng của bạn:</div>
        <div id="pickList" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px"></div>
      </div>

      <div id="chosenBox" class="hidden" style="margin-top:12px">
        <div style="font-weight:700" id="chosenLine"></div>

        <label>Nhập 1 con số (1–999)</label>
        <input id="numInput" type="number" min="1" max="999" placeholder="Ví dụ: 23">

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="checkBtn" class="btn">Xem kết quả</button>
          <button id="copyBtn" class="btn ghost">Sao chép</button>
        </div>

        <div id="resultBox" class="result hidden"></div>
        <div id="playMusicBtnWrap" class="hidden" style="margin-top:8px">
          <button id="playMusicBtn" class="btn ghost">Phát nhạc sinh nhật</button>
          <div class="playHint">Trình duyệt có thể chặn nhạc tự động — nếu không nghe được, bấm nút này.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted">Trạng thái</div>
      <div id="status" style="font-weight:700;margin-top:6px">Chưa chọn tên</div>
      <div id="errorMsg" style="color:#d9534f;margin-top:8px"></div>
      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">
      <div class="muted">Chú ý kỹ thuật</div>
      <ul class="muted">
        <li>Lưu file này thành <strong>index.html</strong> với encoding <strong>UTF-8</strong>.</li>
        <li>Để dùng nhạc, đặt file <strong>happy.mp3</strong> cùng thư mục hoặc chỉnh đường dẫn trong &lt;audio&gt;.</li>
      </ul>
    </div>
  </div>
</div>

<!-- Audio (thêm file happy.mp3 vào cùng thư mục hoặc sửa src thành URL) -->
<audio id="happyAudio" src="happy.mp3" preload="auto"></audio>

<script>
/* ========== DATA (đã nạp sẵn) ========== */
const RAW_LIST = [
  { name: "Nguyễn Nghi Quỳnh", dob: "05/01" },
  { name: "Trần Minh Bảo Hân", dob: "29/03" },
  { name: "Nguyễn Trí Tường", dob: "19/01" },
  { name: "Tô Dương Bảo Khánh", dob: "04/07" },
  { name: "Trần Nguyễn Minh Ngọc", dob: "26/01" },
  { name: "Cao Ngọc Kim Thư", dob: "07/02" },
  { name: "Lương Mai Trang", dob: "06/11" },
  { name: "Trần Nguyễn Minh Ngọc", dob: "18/05" },
  { name: "Trần Hồng Ân", dob: "31/03" },
  { name: "Nguyễn Phạm Thuý Uyên", dob: "12/05" },
  { name: "Cao Ngọc Thiên Kim", dob: "10/05" },
  { name: "Tô Dương Bảo Khánh", dob: "04/07" },
  { name: "Nguyễn Ngọc Phương Nhi", dob: "10/02" },
  { name: "Bùi Hoàng Quân", dob: "17/08" },
  { name: "Nguyễn Ngọc Ngân Hà", dob: "05/04" },
  { name: "Phạm Vũ Bảo Ngọc", dob: "25/07" },
  { name: "Trương Hoàng Tấn Dũng", dob: "04/02" },
  { name: "Nguyễn Minh Đăng", dob: "03/12" },
  { name: "Phạm Quỳnh Hương", dob: "07/12" },
  { name: "Nguyễn Nhựt Minh", dob: "14/08" },
  { name: "Đoàn Minh Thư", dob: "03/07" },
  { name: "Nguyễn Hải Điền", dob: "21/05" },
  { name: "Hồ Mai Phương", dob: "03/11" },
  { name: "Đặng Quang Thiện", dob: "01/03" },
  { name: "Đặng Hoàng Linh Chi", dob: "10/09" },
  { name: "Châu Khả Ái", dob: "03/02" },
  { name: "Nguyễn Duy Hoàng", dob: "08/01" },
  { name: "Đoàn Thể Tần", dob: "04/11" },
  { name: "Ngô Bảo Khoa", dob: "09/05" },
  { name: "Lê Cát Khuê Anh", dob: "13/10" },
  { name: "Trương Tiến Phát", dob: "16/08" },
  { name: "Bùi Quỳnh Anh", dob: "19/10" },
  { name: "Nguyễn Đặng Hoàng Lê", dob: "25/08" },
  { name: "Phùng Thị Lan Phương", dob: "13/05" },
  { name: "Nguyễn Ngọc Huy Khang", dob: "06/07" },
  { name: "Lê Nguyễn Khánh Lynh", dob: "08/08" }
];

/* ========== Helpers ========== */
function normalizeName(s){
  return (s||'').normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/đ/g,'d').replace(/Đ/g,'D')
    .toLowerCase()
    .replace(/\s+/g,' ')
    .trim();
}
function parseDob(ddmm){ const [d,m] = ddmm.split('/').map(x=>parseInt(x,10)); return { day:d, month:m }; }
function localMidnight(date){ const t = new Date(date); t.setHours(0,0,0,0); return t; }
function computeDaysForThisYear(day, month, today = new Date()){
  const t = localMidnight(today);
  const y = t.getFullYear();
  let bd = new Date(y, month-1, day);
  // handle Feb 29 fallback to Feb 28 when necessary
  if (bd.getMonth() !== (month-1)) {
    if (month === 2 && day === 29) bd = new Date(y,1,28);
  }
  bd = localMidnight(bd);
  if (bd.getTime() === t.getTime()) return { isBirthdayToday:true, passed:false, days:0 };
  if (bd.getTime() < t.getTime()) {
    const days = Math.floor((t - bd) / 86400000);
    return { isBirthdayToday:false, passed:true, days };
  } else {
    const days = Math.ceil((bd - t) / 86400000);
    return { isBirthdayToday:false, passed:false, days };
  }
}

/* ========== DOM ========== */
const nameInput = document.getElementById('nameInput');
const findBtn = document.getElementById('findBtn');
const resetBtn = document.getElementById('resetBtn');
const dupeBox = document.getElementById('dupeBox');
const pickList = document.getElementById('pickList');
const chosenBox = document.getElementById('chosenBox');
const chosenLine = document.getElementById('chosenLine');
const numInput = document.getElementById('numInput');
const checkBtn = document.getElementById('checkBtn');
const copyBtn = document.getElementById('copyBtn');
const resultBox = document.getElementById('resultBox');
const status = document.getElementById('status');
const errorMsg = document.getElementById('errorMsg');
const playMusicBtnWrap = document.getElementById('playMusicBtnWrap');
const playMusicBtn = document.getElementById('playMusicBtn');
const happyAudio = document.getElementById('happyAudio');

let selected = null; // chosen {name,dob}

/* ========== Confetti Implementation ========== */
const confCanvas = document.getElementById('confettiCanvas');
const confCtx = confCanvas.getContext && confCanvas.getContext('2d');
let confDPR = window.devicePixelRatio || 1;
function confettiResize(){
  confCanvas.width = window.innerWidth * confDPR;
  confCanvas.height = window.innerHeight * confDPR;
  confCanvas.style.width = window.innerWidth + 'px';
  confCanvas.style.height = window.innerHeight + 'px';
  confCtx.setTransform(confDPR,0,0,confDPR,0,0);
}
if(confCtx){ confettiResize(); window.addEventListener('resize', confettiResize); }

function confettiBurst(count=120){
  if(!confCtx) return;
  const parts = [];
  const colors = ['#ff5a8f','#ffd166','#6df0ff','#6a9bff','#a8ffb0'];
  for(let i=0;i<count;i++){
    parts.push({
      x: Math.random()*window.innerWidth,
      y: Math.random()*window.innerHeight*0.1,
      vx:(Math.random()-0.5)*8,
      vy: Math.random()*6+2,
      w: Math.random()*8+4,
      color: colors[Math.floor(Math.random()*colors.length)],
      ttl: 80 + Math.random()*60
    });
  }
  (function loop(){
    confCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
    for(let i=parts.length-1;i>=0;i--){
      const p = parts[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.12;
      p.ttl--;
      confCtx.fillStyle = p.color;
      confCtx.fillRect(p.x, p.y, p.w, p.w*0.6);
      if(p.ttl<=0 || p.y > window.innerHeight + 50) parts.splice(i,1);
    }
    if(parts.length>0) requestAnimationFrame(loop);
    else confCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
  })();
}

/* ========== Interaction Logic ========== */
function showError(msg){ errorMsg.textContent = msg || ''; }
function clearResult(){ resultBox.classList.add('hidden'); resultBox.textContent = ''; }

function findName(){
  showError(''); clearResult(); selected = null;
  const q = nameInput.value || '';
  const n = normalizeName(q);
  if(!n){ showError('Vui lòng nhập họ tên của bạn'); status.textContent = 'Chưa chọn tên'; return; }
  const hits = RAW_LIST.filter(p => normalizeName(p.name) === n);
  if(hits.length === 0){ showError('Vui lòng nhập lại họ tên của bạn'); status.textContent = 'Không tìm thấy'; dupeBox.classList.add('hidden'); chosenBox.classList.add('hidden'); return; }
  if(hits.length === 1){ choosePerson(hits[0]); return; }
  // multiple matches
  pickList.innerHTML = '';
  hits.forEach(h=>{
    const b = document.createElement('button'); b.className = 'btn ghost'; b.textContent = `${h.name} — ${h.dob}`;
    b.addEventListener('click', ()=> choosePerson(h));
    pickList.appendChild(b);
  });
  dupeBox.classList.remove('hidden');
  chosenBox.classList.add('hidden');
  status.textContent = 'Có nhiều trùng tên — cần chọn';
}

function choosePerson(p){
  selected = p;
  dupeBox.classList.add('hidden');
  chosenBox.classList.remove('hidden');
  chosenLine.textContent = `${p.name} — ${p.dob}`;
  status.textContent = 'Đã chọn tên';
  showError('');
  clearResult();
}

function checkNumber(){
  showError('');
  if(!selected){ showError('Chưa chọn tên'); return; }
  const raw = numInput.value;
  const n = Number(raw);
  if(!raw || isNaN(n) || n<1 || n>999){ showError('Nhập 1 số hợp lệ từ 1 đến 999'); return; }
  // compute days vs this year's birthday
  const { day, month } = parseDob(selected.dob);
  const comp = computeDaysForThisYear(day, month, new Date());
  let out = '';

  if(comp.isBirthdayToday){
    // play audio (user gesture is this button click -> most browsers allow)
    try{
      const playPromise = happyAudio.play();
      if(playPromise && typeof playPromise.then === 'function'){
        playPromise.catch(()=> { 
          // show manual play button if blocked
          playMusicBtnWrap.classList.remove('hidden');
        });
      }
    }catch(e){
      playMusicBtnWrap.classList.remove('hidden');
    }
    // confetti + music
    confettiBurst(200);
    const upper = selected.name.toLocaleUpperCase('vi');
    out = `MEL MEL MEL CHÚC MỪNG SINH NHẬT ${upper} MĂM MĂM RỘP RỘP!!!!!\n\n(Bạn đã nhập: ${n})`;
  } else {
    // not birthday -> only confetti
    confettiBurst(120);
    if(comp.passed){
      if(n === comp.days){
        out = `Mình sẽ giải đáp con số đó\n\nCon số đó là số ngày kể từ ngày sinh nhật của cậu (${comp.days} ngày), dù sao thì chúc mừng nhe<3`;
      } else {
        out = `Con số này ko liên quan nhưng mà đã qua ${comp.days} (số ngày) kể từ sinh nhật bạn rồi`;
      }
    } else {
      if(n === comp.days){
        out = `Ten tèn ten, con số bạn chọn chính là còn ${comp.days} (số ngày) nữa sẽ tới sinh nhật bạn rồi, congratulations!!!`;
      } else {
        out = `Uhm thôi kệ số đó đi, còn ${comp.days} (số ngày) nữa sẽ tới sinh nhật bạn rồi, hẹ hẹ hẹ`;
      }
    }
  }

  resultBox.classList.remove('hidden');
  resultBox.textContent = out;
}

/* manual play button if browser blocked autoplay */
playMusicBtn.addEventListener('click', ()=> {
  happyAudio.play().catch(()=> alert('Không thể phát nhạc — kiểm tra file/máy người dùng'));
});

/* events */
findBtn.addEventListener('click', findName);
resetBtn.addEventListener('click', ()=>{
  nameInput.value=''; numInput.value=''; selected=null; dupeBox.classList.add('hidden'); chosenBox.classList.add('hidden'); showError(''); status.textContent='Chưa chọn tên'; clearResult();
});
checkBtn.addEventListener('click', checkNumber);
copyBtn.addEventListener('click', ()=>{
  if(resultBox.classList.contains('hidden')){ showError('Chưa có kết quả để sao chép'); return; }
  navigator.clipboard?.writeText(resultBox.textContent).then(()=>{}, ()=> prompt('Sao chép kết quả:', resultBox.textContent));
});

/* Enter to find */
nameInput.addEventListener('keydown', e => { if(e.key === 'Enter') findName(); });

</script>
</body>
</html>
